$( document ).ready( function() {
	
	// The following code is only called on the index page of the appointments controller
	if( $( 'body.appointments').length && $( 'body.index' ).length ) {
		$( '#calendar' ).fullCalendar({
			defaultView: 'agendaWeek',
			doctorsSource: '/doctors/list',
			eventSources: ['/appointments/findByDate'],
			allDaySlot: false,
			minTime: '7:30am',
			maxTime: '6:00pm',
			slotMinutes: 10,
      selectable: true,
      selectHelper: true,
      eventClick: function(calEvent, jsEvent, view, start_time, end_time, start_date, end_date) {
          alert('Event: ' + calEvent.title + start_time + end_time);
          id= calEvent.id;

          $( "#dialog" ).dialog({
              resizable: false,
              height:100,
              width:500,
              modal: true,
              title: 'Want you want to do?',
              buttons: {
                  CLOSE: function() {
                      $("#dialog").dialog( "close" );
                  },
                  DELETE: function(data) {
                      $.post('/appointments/destroy'+calEvent.id, {"appointment_id": calEvent.id},
                             $("#appointment_id").id, //need to add the id param here see latest addition to bookmarks
                        function(data){
                            $('#calendar').fullCalendar("removeEvents", (data));
                            $('#calendar').fullCalendar("rerenderEvents");
                        });
                  }
              }
          });

          // change the border color just for fun
          $(this).css('border-color', 'red');
      },
      dayClick: function(start_date, end_date, start_time, end_time, allDay, name) {
          var title = $( "#title").text();
          $('#add-event').dialog({
              url: $(this).parent("form").attr("action") + "?&authenticity_token=" ,
              data:$(this).parent("form").serialize(),
            resizable: false,
            position: top,
            modal: true,
            buttons: {
                "Confirm": function() {
                  // Send the contents of the add event form to the create action on the appointments controller using an ajax call
                  $.post(
                    "/appointments/new",
                    $('#add-event-form').serializeArray(),
                    function( data ) {
                      // TODO: check if the appointment was saved successfully. If not, display the error
                      // If the appointment was created successfully then create the event on the calendar
                      // TODO: check if the appointment was actually saved properly
                      $( "#calendar" ).fullCalendar('renderEvent',
                              {
                                  start_date: date,
                                  end_date: date,
                                  name: text,
                                  start_time: start,
                                  end_time: end,
                                  allDay: allDay
                              },
                              true // make the event "stick"
                      );
                      $( this ).dialog( "close" );
                      $( "#calendar" ).fullCalendar('unselect');
                    } // end success handler
                  ); // end ajax post call
                } // end confirm button handler
            } // end buttons
          }); // end dialog creation
          } // end Dayclick function
      }); // end fullCalendar creation

      $("#search").autocomplete({
          source: "/doctors/search"
      });
      $("#find ").autocomplete({
          source: "/doctors/search"
      });
      $( "#start_time_date_equals").datepicker();
      $( "#event-date").datepicker();
      $( "#start_time").timepicker();
      $( "#end_time").timepicker();
	}
	
	// New appointment page
	if( $( 'body.appointments' ).length && $( 'body.new' ).length ) {
        $("#appointment_doctor_name").autocomplete({
            source: "/doctors/search"
        })
		

        //$( "#appointment_start_time").timepicker();
        //$( '#appointment_start_time.time').timepicker({
       //     'showDuration': true,
       //     'timeFormat': 'g:ia'
        //});
       // $( '#appointment_start_time.date').datepicker({
        //    'format': 'm/d/yyyy',
        //    'autoclose': true
       // });
       // $('#appointment_start_time').datepair();
        // initialize input widgets first

        // initialize input widgets first
        $('input.time').timepicker({
            'showDuration': true,
            'timeFormat': 'g:ia'
        });

        $('input.date').datepicker({
            'dateFormat': 'dd/mm/yy',
            'autoclose': true
        });

        $('#appointment_time').datepair({
      		updateDate: function($input, dateObj){
      			$input.datepicker('setDate', dateObj);
      		}
        });
        
	}
	
});
